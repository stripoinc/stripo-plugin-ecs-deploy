#!/bin/bash

echo "🔍 Checking PostgreSQL status..."

# Check PostgreSQL connection
echo "📊 Checking PostgreSQL connection on {{ pg_host_ip }}:5432..."

# Check port availability
if timeout 5 nc -z {{ pg_host_ip }} 5432; then
    echo "✅ Port 5432 is available"
else
    echo "❌ Port 5432 is unavailable"
    exit 1
fi

# Check connection using psql (if installed)
if command -v psql >/dev/null 2>&1; then
    echo "📊 Checking database connection..."
    
    # Attempt to connect to database
    if timeout 10 psql -h {{ pg_host_ip }} -p 5432 -U postgres -d postgres -c "SELECT version();" >/dev/null 2>&1; then
        echo "✅ PostgreSQL connection successful"
        echo "📋 PostgreSQL version:"
        timeout 10 psql -h {{ pg_host_ip }} -p 5432 -U postgres -d postgres -c "SELECT version();" 2>/dev/null | head -2
    else
        echo "⚠️  Failed to connect to database (password may be required)"
        echo "📋 Checking service availability..."
    fi
else
    echo "⚠️  psql is not installed, checking only port availability"
fi

# Check service status via SSH
echo "🔧 Checking PostgreSQL service status..."
ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 -i ssh_keys/stripo-ansible-key ubuntu@{{ pg_host_ip }} "sudo systemctl status postgresql" 2>/dev/null | head -10

echo "✅ PostgreSQL check completed" 